# Контроль лидов: логика и рабочий процесс

## Зачем этот дашборд

Дашборд нужен, чтобы:
1. **Видеть все лиды** в одном месте (облако), разбитые по очередям: Первичка, Вторичка, Аренда, Рекламные кампании.
2. **Назначать лиды на менеджеров** — кто какой лид обрабатывает (вручную или по правилу).
3. **Настраивать, как раздаются лиды** — по кругу, по загрузке или только вручную, и кто имеет право раздавать.
4. **Вести справочники**: менеджеры (кому назначаем) и партнёры по email (кому «водятся» лиды в ЛК).
5. **Смотреть аналитику**: воронка продаж, объёмы по очередям, разбивка по менеджерам и стадиям.

---

## Кто заходит и с какими правами

| Роль | Кто это | Что видит и что может |
|------|--------|------------------------|
| **Директор** | Пользователь с `leadAdminRole: 'director'` | Всё: облако, назначение лидов, настройки (правило + распределитель), добавление/редактирование/удаление менеджеров и партнёров, аналитика. |
| **РОП** | Пользователь с `leadAdminRole: 'rop'` | По задумке: просмотр облака и ручное назначение лидов, **если** он назначен «распределителем» в настройках. Сейчас в коде ограничение «только распределитель назначает» **не проверяется** — любой с доступом может назначать. Настройки, менеджеры, партнёры — только просмотр или блок «только для директора». |
| **Нет доступа** | Нет роли директора/РОП | Страница «Контроль лидов» показывает экран «Нет доступа». |

Текущий пользователь задаётся моком в `portal-user.ts` и `leads-mock.ts` (CURRENT_PORTAL_USER_ID).

---

## Куда попадают лиды, которые ещё никому не назначены

**В данных:**  
Все лиды хранятся в едином пуле `leadPool`. У каждого лида есть поле `managerId`: если оно `null`, лид считается неназначенным. Новые лиды (при добавлении через ADD_LEAD) сейчас всегда попадают в пул с `managerId: null` — автоматическое назначение по правилу (round_robin / by_load) не реализовано.

**В интерфейсе:**

1. **Блок «Неназначенные лиды»** (вкладка «Облако лидов», вверху страницы) — это **единственное место**, где собраны все такие лиды в одном списке. Сюда «падают» все лиды без менеджера: и только что пришедшие, и те, с кого сняли назначение. Здесь же выбирают менеджера и назначают (все сразу или по одному).

2. **Карточки очередей** (Первичка, Вторичка, Аренда, Рекламные кампании) показывают лидов **по типу очереди**, а не по назначенности: в каждой карточке есть и назначенные, и неназначенные лиды. Неназначенные в строке отображаются как «Не назначен» или с пустым выбором менеджера. То есть один и тот же неназначенный лид виден и в блоке «Неназначенные лиды», и в карточке своей очереди.

3. **Аналитика** (вкладка «Аналитика»): при выборе «Менеджер для аналитики» → «Не назначен» показывается разбивка по стадиям именно по лидам с `managerId: null`.

**Итог:** Неназначенные лиды «лежат» в общем облаке (`leadPool`) с `managerId: null`. В интерфейсе они явно собраны в блоке **«Неназначенные лиды»** на вкладке «Облако лидов» — сюда они и «падают», и отсюда их назначают на менеджеров. В карточках очередей они дублируются для удобства просмотра по типам аккаунтов.

---

## Что делает каждый модуль

### 1. Облако лидов (вкладка «Облако лидов»)

- **Назначение**: показывать лиды по очередям и давать возможность их назначать на менеджеров.
- **Что есть**:
  - Четыре карточки по типам очередей (Первичка, Вторичка, Аренда, Рекламные кампании): в каждой — число лидов и превью списка.
  - Блок **«Неназначенные лиды»**: список лидов без менеджера, выбор «Назначить на менеджера» и кнопка «Назначить все на выбранного», плюс назначение по одному и открытие карточки лида.
  - Клик по строке лида → карточка лида (детали + выбор менеджера с полным именем).
  - Кнопка «Показать все N лидов» по очереди → диалог со полным списком по этой очереди.
  - Внизу — блок «Всего в облаке» с общим количеством лидов.
- **Откуда данные**: `leadPool` и `leadManagers` из контекста (состояние + мок).

### 2. Настройки (вкладка «Настройки»)

- **Назначение**: задать, как лиды раздаются по менеджерам, и кто имеет право раздавать вручную.
- **Доступ**: только директор. РОП видит карточку «Только для директора».
- **Что есть**:
  - **Правило раздачи**: тип — «По кругу (round-robin)», «По загрузке», «Только ручная раздача». Значение сохраняется в `distributionRule.type`.
  - **Менеджер в рукопашном режиме (распределитель)**: выбор одного менеджера из списка или «Не назначен». Сохраняется в `manualDistributorId`.
- **Важно**: смена правила и распределителя **ни на что не влияет** в текущей логике: нет кода, который при появлении лида автоматически назначает его по round_robin или by_load, и нет проверки «назначать может только текущий распределитель».

### 3. Менеджеры (вкладка «Менеджеры»)

- **Назначение**: справочник людей, **на кого** назначаются лиды (кому они «уходят» в работу).
- **Доступ**: добавление, редактирование и удаление — только директор.
- **Что есть**: список менеджеров (имя, логин/email, очереди-права: Первичка, Вторичка, Аренда, Рекламные кампании), кнопки «Редактировать» и «Удалить», диалог добавления/редактирования с полями логин, имя и выбор очередей.
- **Связь с логикой**: при назначении лида в облаке в селекте показываются только те менеджеры, у которых в `sourceTypes` есть очередь этого лида. Справочник менеджеров — единственный источник, откуда берутся варианты «назначить на».

### 4. Партнёры по email (вкладка «Партнёры по email»)

- **Назначение**: справочник партнёров (по email ЛК), **кому водятся лиды** (в каком-то внешнем смысле — ЛК, отчёты и т.п.).
- **Доступ**: добавление и удаление — только директор.
- **Что есть**: список записей (email, очередь, опционально город), кнопки добавить/удалить.
- **Пробел**: в коде нет связи «лид → партнёр». Облако лидов не фильтруется по партнёру, лиды не привязываются к `leadPartners`. Модуль выглядит как справочник без использования в текущей логике раздачи и отображения.

### 5. Аналитика (вкладка «Аналитика»)

- **Назначение**: показать, как идут лиды по воронке и по людям.
- **Что есть**:
  - **Воронка продаж**: те же этапы CRM, что в канбане (сетевые данные), переключатель периода (неделя/месяц/всё время), конверсии и канбан по этапам.
  - **Куда сливается лидогенерация**: объёмы по очередям (Первичка, Вторичка, Аренда, Рекламные кампании) из **облака лидов** (`leadPool`).
  - **Аналитика по менеджерам**: выбор «Менеджер для аналитики» (все / конкретный / «Не назначен»), таблица по всем или карточка по выбранному менеджеру — разбивка лидов по стадиям воронки. Данные из `leadPool` (назначения и стадии лидов).

---

## Как сейчас выглядит рабочий процесс (по шагам)

1. **Вход**: пользователь с ролью директора или РОП заходит в приложение и в меню выбирает «Контроль лидов». Иначе видит «Нет доступа».
2. **Настройка (директор)**:
   - В «Настройках» выбирает правило раздачи (round_robin / by_load / manual) и при необходимости назначает «распределителя» в ручном режиме. На поведение системы это пока не влияет.
   - В «Менеджерах» добавляет/редактирует менеджеров и их очереди (права).
   - В «Партнёрах по email» при необходимости ведёт список партнёров (на логику облака не влияет).
3. **Работа с лидами**:
   - Лиды попадают в облако (сейчас только из мока; в реальности ожидается интеграция с формами/CRM/рекламой).
   - В «Облаке лидов» пользователь видит неназначенные лиды и списки по очередям. Выбирает менеджера и назначает лиды (все неназначенные на одного или по одному), при необходимости открывает карточку лида.
   - Кто именно может нажимать «назначить», в коде не различается: проверки «только распределитель» или «только директор» нет.
4. **Аналитика**: выбор периода и при необходимости менеджера, просмотр воронки, объёмов по очередям и разбивки по стадиям.

---

## Что недоработано с точки зрения логики

1. **Правило раздачи не применяется**  
   При добавлении лида (ADD_LEAD) он просто попадает в пул с `managerId: null`. Нет логики:
   - при `round_robin` — автоматически выбрать следующего менеджера по кругу (по очереди лида) и выставить `managerId`;
   - при `by_load` — выбрать менеджера с наименьшей загрузкой по этой очереди и назначить.
   То есть «Правило раздачи» в настройках только сохраняется, но не используется.

2. **Права на назначение не проверяются**  
   В интерфейсе облака лидов назначение доступно всем, у кого есть доступ в раздел (`canAssign = true` без условий). По смыслу:
   - при ручном режиме назначать должен только выбранный «распределитель» (и, возможно, директор);
   - при автоматическом режиме ручное назначение может быть запрещено или ограничено.  
   Этого в коде нет.

3. **Партнёры по email не задействованы**  
   Справочник есть, но ни облако, ни аналитика, ни назначение лидов с ним не связаны. Не определено: как лид «привязывается» к партнёру, как партнёр видит своих лидов, нужно ли вообще показывать партнёра в карточке лида или в фильтрах.

4. **Нет входящего потока лидов**  
   Лиды только моковые. Не описано и не реализовано: откуда приходят лиды (форма, API, CRM), как они попадают в облако, с какими полями (в т.ч. партнёр, источник/канал). Без этого «рабочий процесс» обрывается на ручном назначении уже существующих в пуле лидов.

5. **Связь «пользователь портала ↔ менеджер по лидам»**  
   Менеджеры в справочнике — отдельные сущности (id, login, name, sourceTypes). Не задано: совпадает ли текущий пользователь портала с одним из менеджеров (например по email), и должны ли у него быть отдельные права «вижу только своих лидов» или «назначаю только в свои очереди». РОП и «распределитель» в таком виде не привязаны к одному и тому же лицу в коде.

---

## Краткая сводка по модулям

| Модуль | Назначение | Где пробел |
|--------|------------|------------|
| Облако лидов | Показ лидов по очередям, неназначенные, назначение на менеджера, карточка лида | Нет проверки «кто может назначать»; правило раздачи не используется |
| Настройки | Правило раздачи + выбор распределителя | Правило не применяется при появлении лидов; распределитель не ограничивает право назначения в UI |
| Менеджеры | Справочник «на кого назначаем», права по очередям | Работает согласованно с облаком |
| Партнёры по email | Справочник «кому водятся лиды» | Не используется в логике облака и назначения |
| Аналитика | Воронка, объёмы по очередям, разрез по менеджерам/стадиям | Данные по облаку и менеджерам согласованы; воронка из сетевого мока |

Если нужно, следующим шагом можно расписать конкретные доработки (например: где вызывать автоназначение при ADD_LEAD, где проверять распределителя, как привязать партнёра к лиду).
